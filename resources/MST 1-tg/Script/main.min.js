var fynseApp = angular.module("fynseApp", []);
fynseApp.directive("myRepeatDirective", function() {
    return function(scope, element, attrs) {
        if (scope.$last) $("textarea").keyup()
    }
});
fynseApp.factory("DataSource", ["$http", function($http) {
    return {
        get: function(callback) {
            callback(data)
        }
    }
}]);
fynseApp.controller("MainCtrl", function($scope, DataSource) {
    $scope.topNavStep = 1;
    $scope.mainData;
    $scope.Chakpter;
    $scope.selectedChapter = 0;
    $scope.SchoolName = "";
    $scope.questionPadding = 6;
    $scope.UniqueId = "QPGen";
    $scope.isSavedData = false;
    $scope.sellectedArr = [];
    $scope.versionName = "";
    $scope.versionArray = [];
    $scope.schoolLogo = "";
    $scope.inHistory = false;
    $scope.setData = function(data) {
        $scope.mainData = data["QuestionPaper"];
        $scope.UniqueId = "QPGen-" + $scope.mainData["-UniqueId"];
        $scope.categoryName = $scope.mainData["-CategoryName"];
        $scope.Chapter = $scope.mainData["Chapter"];
        angular.forEach($scope.Chapter, function(Chapter) {
            if (!Chapter["Cluster"].length) Chapter["Cluster"] = [Chapter["Cluster"]];
            angular.forEach(Chapter["Cluster"], function(Cluster) {
                if (!Cluster["item"].length) Cluster["item"] = [Cluster["item"]]
            })
        });
        if (localStorage)
            if (localStorage.getItem($scope.UniqueId)) {
                $scope.isSavedData = true;
                $scope.versionArray = JSON.parse(localStorage.getItem($scope.UniqueId))
            }
    };
$scope.setChapter = function(pes) {
    $scope.selectedChapter = pes;		
   };
    $scope.setQuestionSelected =
        function(res) {
        res.selected = res.selected == true ? false : true
       };
		
    $scope.selected = function(jes) {
       var count = 0;
       $scope.Chapter[jes]["Cluster"];
        angular.forEach($scope.Chapter[jes]["Cluster"], function(Cluster) {
           angular.forEach(Cluster["item"], function(item) {
                count += item.selected == true ? 1 : 0
            })
       });
       return count
  };
    $scope.selectedTotal = function() {
        var count = 0;
        angular.forEach($scope.Chapter, function(Chapter) {
            angular.forEach(Chapter["Cluster"], function(Cluster) {
                angular.forEach(Cluster["item"], function(item) {
                    count += item.selected ==
                        true ? 1 : 0						
                })
            })
        });
        return count
    };
    $scope.selectAll = function(sel, show) {
        angular.forEach($scope.Chapter[sel]["Cluster"], function(Cluster) {
            angular.forEach(Cluster["item"], function(item) {				               
				item.selected = show
            })			
        })
    };
   $scope.selectAllModule = function(show) {      
	    angular.forEach($scope.Chapter, function(row) {
            $scope.selectAll($scope.Chapter.indexOf(row), show)
        })
    };
    $scope.setTopNav = function(res) {
        if ($scope.selectedTotal() < 1 && res != 1) return;
        if ($scope.inHistory) return;
        $scope.topNavStep = res;
        if (res == 2) {
            $scope.allocateMarksInit();
            $(".allocate-marks").css("display", "block")
         }      
         else $(".allocate-marks").css("display", "none");
        if (res == 3) {
            angular.forEach($scope.sellectedArr, function(Row) {
                shuffleArray(Row.Questions)
            });
            $(".question-preview").css("display", "block");
            $("textarea").keyup()
        } else $(".question-preview").css("display", "none")
    };
    $scope.allocateMarksInit = function() {
        $scope.sellectedArr = [];
        angular.forEach($scope.Chapter, function(Chapter) {
            angular.forEach(Chapter["Cluster"], function(Cluster) {
                var ClusterName = Cluster["-Heading"];
                var DefaultMark = Cluster["-defaultMark"];
                angular.forEach(Cluster["item"], function(item) {
                    if (item.selected) {
                        var objQuestions = [];
                        var isThereCluster = false;
                        angular.forEach($scope.sellectedArr, function(row) {
                            if (row["Cluster"] == ClusterName) {
                                isThereCluster = true;
                                var objQuestions = row["Questions"];
                                var objQst = {};
                                objQst["Question"] = item["-Question"];
                                objQst["OptionImage"] = item["-OptionImage"];
								objQst["Answer"] = item["-Answer"];
							    objQst["Answer(OptionImage)"] = item["-Answer(OptionImage)"]								
                                objQuestions.push(objQst)
                            }
                        });
                        if (!isThereCluster) {
                            var objQst = {};
                            objQst["Question"] = item["-Question"];
                            objQst["OptionImage"] = item["-OptionImage"];
							objQst["Answer"] = item["-Answer"];
						    objQst["Answer(OptionImage)"] = item["-Answer(OptionImage)"];
                            objQuestions.push(objQst);
                            var obj = {};
                            obj["Cluster"] = ClusterName;
                            obj["DefaultMark"] = parseInt(DefaultMark);
                            obj["Questions"] = objQuestions;
                            $scope.sellectedArr.push(obj)
                        }
                    }
                })
            })
        });
        angular.forEach($scope.sellectedArr, function(Row) {
            Row.selQuestions = Row.Questions.length
        })
    };
    $scope.getGrandTotal = function() {
        var count = 0;
        angular.forEach($scope.sellectedArr, function(Row) {
            count += Row.DefaultMark * Row.selQuestions
        });
        return count
    };
    $scope.printDiv = function(divName) {
        var printContents = document.getElementById(divName).innerHTML;
        var originalContents = document.body.innerHTML;          
        var popupWin = window.open("", "_blank", "width=300,height=300");
        popupWin.document.open();
        popupWin.document.write('<html><head><link rel="stylesheet" type="text/css" href="Style/main.css" /></head><body onload="window.print()">' + printContents + "</body></html>");
        popupWin.document.close()
    };
	$scope.printAns = function(divName) {
        var printContent = window.document.getElementById(divName).innerHTML;
        var originalContents = window.document.body.innerHTML;          
        var popupWin = window.open("", "_blank", "width=300,height=300");
        popupWin.document.open();
        popupWin.document.write('<html><head><link rel="stylesheet" type="text/css" href="Style/main.css" /></head><body onload="window.print()">' + printContent + "</body></html>");
        popupWin.document.close()
    };	
    $scope.clearData = function() {
        localStorage.removeItem($scope.UniqueId);
        $scope.isSavedData = false
    };
	 $scope.cancelPopup = function()
	 {
        $("#savePopup").css("display", "none")
     };
    $scope.saveDataAs = function(index) {
        $("#savePopup").css("display", "none");
        var newVersionArr = {
            "versionName": "",
            "data": "",
            "questionPadding": "",
            "schoolName": "",
            "schoolLogo": ""
        };
        newVersionArr.versionName = $scope.versionArray[index].versionName;
        newVersionArr.data = $scope.sellectedArr;
        newVersionArr.questionPadding = $scope.questionPadding;
        newVersionArr.schoolName = $scope.SchoolName;
        newVersionArr.schoolLogo = $scope.schoolLogo;
        $scope.versionArray[index] = newVersionArr;
        localStorage.setItem($scope.UniqueId, JSON.stringify($scope.versionArray));
        var success = generate("success", "Question paper has been saved successfully!");
        setTimeout(function() 
		{
                $.noty.close(success.options.id)
            },
            3E3)
        };
    $scope.saveData = function(verName) {
        if (verName == "") {
            alert("Please enter file name");
            return
        }	
		
   $("#savePopup").css("display", "block");
        if (localStorage) {
            var newVersionArr = 
			{
                "versionName": "",
                "data": "",
                "questionPadding": "",
                "schoolName": "",
                "schoolLogo": ""
            };
            newVersionArr.versionName = verName;
            newVersionArr.data = $scope.sellectedArr;
            newVersionArr.questionPadding = $scope.questionPadding;
            newVersionArr.schoolName = $scope.SchoolName;
            newVersionArr.schoolLogo = $scope.schoolLogo;
            $scope.versionArray.push(newVersionArr);
            localStorage.setItem($scope.UniqueId, JSON.stringify($scope.versionArray));
            var success = generate("success", "Question paper has been saved successfully!");
            setTimeout(function() {
                $.noty.close(success.options.id)
            }, 3E3)
        } else alert("Your browser do not support Save function")
    };
    $scope.openSavedData = function(index) {
        $("#step1").addClass("disabled");
        $scope.inHistory = true;
        $scope.isSavedData = false;
        $scope.sellectedArr = $scope.versionArray[index].data;
        $scope.questionPadding = $scope.versionArray[index].questionPadding * 1;           
        $scope.SchoolName = $scope.versionArray[index].schoolName;
        if ($scope.versionArray[index].schoolLogo) 
		{
            var questionPaperLogo = document.getElementById("question-paper-logo");
            var questionPaperEditLogo = document.getElementById("question-paper-edit-logo");
            questionPaperLogo.src = $scope.versionArray[index].schoolLogo;
            questionPaperEditLogo.src = $scope.versionArray[index].schoolLogo                                  
        }
        $scope.topNavStep = 3;
        $(".allocate-marks").css("display", "none");
        $(".question-preview").css("display", "block");
        $("textarea").keyup();
        $("textarea").keyup()
    };
    $scope.openSaveNewPopup = function()
	 {
        $("#savePopup").css("display", "block")
     };
    DataSource.get($scope.setData)
});
var shuffleArray = function(array) {
    var m = array.length,
        t, i;
    while (m) {
        i = Math.floor(Math.random() * m--);
        t = array[m];
        array[m] = array[i];
        array[i] = t
    }
    return array
};
if (window.File && window.FileReader && window.FileList && window.Blob);
else alert("The File APIs are not fully supported in this browser.");

function handleFileSelect(evt) {
    var file = evt.target.files[0];
    var questionPaperLogo = document.getElementById("question-paper-logo");
	var questionPapLogo = document.getElementById("question-pap-logo");
    var questionPaperEditLogo = document.getElementById("question-paper-edit-logo");
    var reader = new FileReader;
    reader.onload = function(theFile) {
        return function(e) {
            questionPaperLogo.src = e.target.result;
			questionPapLogo.src = e.target.result;
			questionPaperEditLogo.src = e.target.result;
            getScope().schoolLogo = e.target.result
        }
    }(file);
    reader.readAsDataURL(file)
}
jQuery(document).ready(function($) {
    $("#wordExportBtn").click(function(event) {
        $("#printable").wordExport();
		$("#accessable").wordExport()
    })
});

function onLoad() {
    document.getElementById("logoFile").addEventListener("change", handleFileSelect , false);
    $("#logoFileButton").click(function() {
        $("#logoFile").trigger("click")
    })
}

function textAreaAdjust(txt) {
    txt.style.height = "1px";
    txt.style.height = txt.scrollHeight + "px"
}

function generate(type, text) {
    var n = noty({
        text: text,
        type: type,
        dismissQueue: false,
        modal: true,
        layout: "topCenter",
        theme: "defaultTheme"
    });
    console.log(type + " - " + n.options.id);
    return n
}

function getScope() {
    return angular.element($("body")).scope()
};